[TOC]
# 内存虚拟化

**目的:**
(1) 提供给虚拟机一个从零地址开始的的连续物理内存空间->GPA。
(2) 在各虚拟机之间有效隔离、调度以及共享内存资源。
- - -

## 概述
- - -

**客户机物理地址空间:**是客户机操作系统所能看见和管理的物理地址空间，这个地址空间不是真正的物理地址空间，它和真正的物理地址空间还有一层映射。
_ _ _

**两层映射:**
(1) GVA(Guest Virtual Address)->GPA(Guest Physical Address)，由客户机操作系统自己完成。
(2) GPA(Guest Physical Address)->HPA(Host Physical Address)，由VMM负责。
_ _ _

为了实现上述(2)映射的转换，VMM为每个虚拟机动态地维护了一张从GPA到HPA映射关系的表。客户机操作系统看起来连续的GPA，其对应的HPA可能是不连续的。
_ _ _

**页共享技术:**通过将不同的客户机的某些GPA映射到相同的HPA，来实现共享该HPA对应的物理页。
_ _ _

此外，VMM还可以把GPA映射到另一张新的HPA所在的物理页上；也可以把该GPA对应的HAP所在的物理页换出到硬盘上。
- - -

## 影子页表

**Shadow Page Table(影子页表):**是被物理MMU所装载使用的页表，VMM为每一个客户机操作系统中的每一套页表都维护了一套相应的影子页表。影子页表可以实现GVA到HPA的直接转换，省去了**概述**中的两次转换。此外在TLB和CPU缓存上缓存的是来自影子页表从GVA到HPA的映射，因此大大降低了额外的性能开销。
_ _ _

==当客户机操作系统修改从客户机GVA到客户机GPA的内存映射关系，即修改客户机所维护的客户机页表时，为了保证一致性，VMM必须对影子页表做相应的维护。因此，VMM必须截获这样的内存访问操作，修改在影子页表中同一客户机GVA到宿主机HPA的映射关系。这会带来性能开销，事实上这也是软件虚拟化所带来的主要开销之一。==
_ _ _

影子页表的建立与修改都是由VMM完成的，VMM可以控制影子页表的页访问权限，也总是可以控制何时和怎样截获客户机操作系统对客户机页表的修改。
- - -

**影子页表的优点:**
由于提供了影子页表供物理MMU直接寻址使用，大多数的内存访问可以在不受VMM干预的情况下正常执行，虽然这可以减少时间上的开销，但与非虚拟环境相比仍然有一定差距。
_ _ _
**影子页表的缺点:**
由于VMM需要为每个客户机操作系统的每套页表结构都维护一套相应的影子页表，这会带来空间上的额外开销。

- - -
### 影子页表的结构
在影子页表中，每个页表项包含的都是宿主机物理地址HPA。



