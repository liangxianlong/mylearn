# 中断虚拟化

* [概述](#概述)
* [虚拟PIC](#虚拟PIC)
* [虚拟I/O APIC](#虚拟I/O APIC)
* [虚拟Local APIC](#虚拟Local APIC)
* [中断采集](#中断采集)
* [中断注入](#中断注入)
* [案例分析](#案例分析)

## 概述

在介绍中断虚拟化之前，先看一下物理平台上的中断架构。如下图所示为物理平台上的外部中断流程。

![物理平台的中断架构](./assets/physical_interrupt.png)

首先，I/O设备通过中断控制器(IO APIC或者PIC)发出中断请求，中断请求经由PCI总线发送到系统总线上，最后目标CPU的Local APIC部件接收中断，CPU开始处理中断。

在虚拟机环境中VMM也需要为客户机操作系统展现一个与物理中断架构类似的虚拟中断架构。下图所示为虚拟机的中断架构。

![虚拟机的中断架构](./assets/virtual_interrupts.png)

总的来说，中断虚拟化需要实现如下功能：

- 为每一个vCPU维护一个对应的虚拟Local APIC用于接收中断。
- 虚拟I/O APIC或者虚拟PIC用于发送中断。
- 虚拟Local APIC利用VT-x的事件注入机制将中断注入到相应的vCPU。

因此总的来说，中断虚拟化的任务就是要实现上图所描述的虚拟机中断架构。

## 虚拟PIC

虚拟PIC的实现其实就是根据PIC硬件规范，在软件上模拟出虚拟PIC，为虚拟机提供和物理PIC一样的接口。

虚拟PIC首先要虚拟出和物理PIC一样的软件接口。物理PIC为软件提供了如下接口用于操作PIC。

- 4个初始化命令字(Initialization Command Words)：ICW1~4，用于初始化操作。
- 3个操作命令字(Operation Command Words)：OCW1~3，用于操作PIC。

由于在IA32平台上，物理PIC的ICW1~4和OCW1~3都是通过端口访问的。因此，VMM可以设置VMCS的I/O bitmap中的相应位，使得客户机在访问这些端口时发生VM-Exit，便于VMM截获。

VMM截获这些接口的访问以后，接下来就是按照PIC硬件规范实现对这些接口的定义，实现对应逻辑。

最后虚拟PIC不仅需要为客户机提供正确的虚拟接口，还要为虚拟设备提供接口用于发送中断请求。

## 虚拟I/O APIC
