# IO虚拟化的实现

* [设备直接分配](#设备直接分配)
* [设备IO地址空间的访问](#设备IO地址空间的访问)
* [设备发现](#设备发现)
* [配置DMA重映射数据结构](#配置DMA重映射数据结构)

## 设备直接分配

设备直接分配主要存在如下两个问题。

- 如何阻止来自未分配到该设备的客户机的IO访问。
- 如何让客户机的IO操作直接访问到设备真实的IO地址空间。

对于第一个问题，最直接的方法就是**隐藏**。例如可以在拥有硬件设备的客户机/宿主机加载驱动程序前，先给要分配出去的设备加载一个伪驱动占位符。

对于第二个问题，请参考[`设备IO地址空间的访问`](#设备IO地址空间的访问)一节。

## 设备IO地址空间的访问

**本节只讨论PCI设备在设备直接分配的情况下，客户机如何直接访问设备的真实IO地址空间。**

在实现设备直接分配时，目前采用的方法时建立转换表，报告虚拟的PCI BAR给客户机，当客户机访问到虚拟的IO地址空间时，VMM负责截获操作，并通过转换表把IO请求转发到设备的IO地址空间。

根据IO地址空间的划分，转换表分为如下两种。

- Port IO转换表。
- MMIO转换表。

对于Port IO，可以通过IO bitmap来控制客户机访问某个端口是否引起VM-Exit。这样就可以使用虚拟BIOS为分配给客户机的真实设备而生成虚拟的PCI BAR，请将它报告给客户机操作系统。同时，VMM维护一张虚拟PCI BAR到真实PCI BAR的映射表。当客户机通过虚拟的PCI BAR发起IO操作时，会因为VM-Exit陷入到VMM中，VMM即可通过转换表获得真实设备的IO端口，帮客户机将请求转发给真实硬件。

对于MMIO，其访问方式与内存虚拟化中介绍的内存访问无异。在虚拟BIOS产生虚拟PCI BAR后，只需将虚拟的MMIO地址空间映射到设备真实的MMIO地址空间上，当客户机通过虚拟的MMIO地址空间访问设备时，内存虚拟机制会处理一切。

## 设备发现

VMM通常会同时使用多种IO虚拟化技术，其中一项必然会虚拟PCI总线，所以只需将真实设备挂接到这条虚拟的PCI总线上，客户操作系统枚举PCI设备时必然会发现它。在物理机中，PCI设备暴露给操作系统的接口是PCI配置空间，因此可以将真实设备的PCI配置空间暴露给客户操作系统。

## 配置DMA重映射数据结构

每个客户机都有一张IO页表，通常在客户机创建初期根据客户机的内存大小、VT-d硬件支持的页表级数、页大小创建。此外，使用VT-d技术进行DMA重映射的关键在于为所分配的设备正确设置Root Entry和Context Entry，以及建立IO页表。